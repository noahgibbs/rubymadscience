<%= javascript_pack_tag 'steps' %>

<div class="container">
  <h1><%= @topic.name %></h1>

  <p><%= @topic.desc.html_safe %></p>

  <% steps = @topic.steps %>
  <% if steps.empty? %>
    <p>No steps! Something is wrong with this topic!</p>
  <% else %>
    <% steps.each do |step|
        if current_user
            user_step_item = UserStepItem.where(user_id: current_user.id, step_id: step.id).first
        end
        doneness = user_step_item ? user_step_item.doneness : 0
        %>
        <div class="step-row" data-server-value="<%= doneness %>">

            <%= render "step", step: step %>

            <% if current_user %>
                <div class="done-select-group">
                    <div class="select-error-box error"></div>
                    <button data-step-id="<%= step.id %>" class="mark-done-button btn btn-primary" <%= doneness != 0 ? 'disabled' : '' %> >Mark Done</button>
                    <label for="<%= step.id %>-done-select">Done?</label>
                    <%= select_tag("#{step.id}-done-select", options_for_select(UserStepItem.done_selector, doneness), class: "done-select", data: { step_id: step.id }) %>
                </div>
            <% else %>
                <div class="done-select-group">
                    <label for="<%= step.id %>-done-select">Done?</label> (<%= link_to("Log in", new_user_session_path) %> to track progress)
                </div>
            <% end %>
        </div>
    <% end %>
    <% if @topic.data["related"] && !@topic.data["related"].empty? %>
        <p>
            Looking for similar topics? Try these!
        </p>

        <ul>
            <% @topic.data["related"].each do |rel_topic_id|
                rel_topic = Topic.find(rel_topic_id)
                %>
                <li><a href="/topics/show?id=<%= rel_topic_id %>"><%= rel_topic.name %></a></li>
            <% end %>
        </ul>
    <% end %>
  <% end %>
</div>
